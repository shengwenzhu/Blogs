# 其他

## 1. 设置键的过期时间

可以通过 4 条命令设置键的生存时间或者过期时间；

```sql
-- 为键设置生存时间，当生存时间为0时，服务器会自动从数据库删除该键
EXPIRE key seconds			-- 以秒为单位
PEXPIRE key milliseconds	-- 以毫秒为单位
-- 为键设置过期时间，当到达过期时间时，服务器会自动从数据库删除该键
EXPIREAT key timestamp
PEXPIREAT key milliseconds-timestamp

-- 查看键的剩余生存时间
TTL key		-- 以秒为单位
PTTL key	-- 以毫秒为单位

-- 移除键的生存时间
PERSIST key
```

EXPIRE、PEXPIRE、EXPIREAT命令最终都是通过PEXPIREAT命令实现；

+ 实现原理

  Redis 通过一个 **过期字典** 保存键的过期时间，过期字典的键指向数据库中的某个键，值保存了键的过期时间（一个毫秒精度的Unix时间戳）；

+ 过期键删除策略

  有三种不同的删除策略：
  + 定时删除

    在设置键的过期时间的同时，创建一个定时器，**在键的过期时间到达时立即对键进行删除**；

    优点：可以立即清除过期的数据，对内存很友好；

    缺点：如果过期键比较多，删除过期键会占用较多CPU时间；

  + 惰性删除

    当访问键时，检查键是否已过期，如果过期删除该键；

    优点：可以最大化地节省CPU资源；

    缺点：浪费很多内存；极端情况可能出现大量的过期键没有再次被访问，从而不会被清除，占用大量内存；

  + 定期删除

    每隔一段时间，对数据库进行一次检查，删除过期键；

    该策略是对前两种策略的一个折中方案，通过设置删除操作的执行时长和执行频率可以在使用CPU时间和避免浪费内存空间之间取得平衡；

**Redis 服务器使用惰性删除和定期删除两种策略删除过期的键**；



### AOF、RDB、主从复制对过期键的处理

创建新 RDB文件时，已过期的键不会保存到新创建的 RDB 文件中；

启动 Redis 服务器时，如果通过载入RDB 文件恢复数据库，程序会对文件中保存的键进行检查，过期键不会载入到数据库中；

**当过期键被惰性删除或者定期删除后，AOF 文件会追加一条 DEL 命令，显示删除过期键；**

AOF 重写时，程序会对文件中保存的键进行检查，过期键不会保存到重写后的 AOF 文件中；

从服务器的过期键删除动作由主服务器控制：主服务器在删除一个过期键后，会显式向所有从服务器发送一个DEL命令，告知从服务器删除过期键；从服务器在执行客户端的读命令时，即使碰到过期键也不会将过期键删除，而是继续以处理未过期键的方式处理过期键；



## 2. Redis 优缺点

**优点**：

+ 纯内存操作，读写速度非常快；

  > Redis 读的速度是 110000 次/s，写的速度是 81000 次/s；

+ 高并发：Redis 能够承受的数据库请求数量远大于数据库；

**缺点**：

+ 由于是内存数据库，所以单台机器存储的数据量受机器本身物理内存的限制；



## 3. Redis 与 Memcached 区别

+ **Memcached**

  Memcached 是一个开源的、高性能、分布式缓存系统；

  基于内存的键值对存储系统；

+ **Redis 与 Memacached 区别**

  + 支持的数据类型：Redis 可以存储 5 种数据类型的值，Memacached 只能存储字符串类型的值；
  + 是否支持数据持久化：Redis支持数据持久化，数据库宕机可以通过磁盘文件恢复数据库状态，所以具有灾难恢复机制；Memacached 不支持数据库持久化；
  + 内存管理机制：Redis 可以将不用的数据存储到磁盘，Memcached 的数据会一直存储在内存中，在内存使用完之后，会直接报错；
  + 线程模型：Redis 是单线程多路 IO 复用模型；Memcached 是多线程模型；
  + 过期键删除策略：Redis 使用惰性删除和定期删除两种方式，Memcached 只使用了惰性删除；



## 4. 键空间通知/键事件通知

键空间通知使得客户端通过订阅频道或模式， 来接收那些以某种方式改动了 Redis 数据集的事件；

键空间通知关注“某个键执行了什么命令”，键事件通知关注“某个命令被什么键执行了”；

> Redis 目前的订阅与发布功能采取的是**发送即忘（fire and forget）策略**， 所以如果程序需要可靠事件通知（reliable notification of events）， 那么目前的键空间通知并不适合： 当订阅事件的客户端断线时， 它会丢失所有在断线期间分发给它的事件；

键空间通知功能在默认配置下处于关闭状态，可以通过服务器配置的 notify-keyspace-events 选项开启键通知功能；



## 5. Redis 事务

Redis 事务的本质是**一组命令的集合**，Redis会将一个事务中的所有命令序列化，然后按顺序执行；

单个 Redis 命令的执行是原子性的，Redis 事务不满足**原子性**（事务中任意命令执行失败，其余的命令依然被执行）；

Redis满足**隔离性**；

```
MULTI 	标记一个事务的开始
EXEC	执行事务的所有命令
WATCH	监视key值，当这些key在事务执行之前被改变，取消事务的执行；
```





















































































> 
>
