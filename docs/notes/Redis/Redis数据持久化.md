# 数据持久化

数据持久化就是将内存中的数据写入到磁盘中，防止 Redis 进程退出或服务器宕机数据丢失；

Redis 支持两种数据持久化方式：

+ RDB 持久化
+ AOF 持久化

## 1. RDB 持久化

RDB 持久化就是将数据库中的所有数据生成快照保存到硬盘；

> Redis 默认采用的持久化方式

有两种方式触发 RDB 持久化：

+ 手动触发

  + 通过 save 命令：该命令会阻塞当前 Redis 服务器进程，直到 RDB 过程完成为止；（不推荐使用）
  + 通过 bgsave 命令：该命令会创建一个子进程，由子进程负责 RDB 持久化过程；

+ 自动触发

  通过配置服务器定期执行 RDB 持久化；

  ```
  在 Redis 服务器配置文件中，通过如下命令格式配置：
  命令格式：save <seconds> <changes>
  表示指定时间内执行的修改操作大于指定次数就触发一次 RDB 持久化
  示例：
  save 900 1		# after 900 sec (15 min) if at least 1 key changed
  save 300 10		# after 300 sec (5 min) if at least 10 keys changed
  save 60 10000	# after 60 sec if at least 10000 keys changed
  可以配置多条触发条件，只要满足其中任一条件，就触发一次 RDB 持久化
  ```

### RDB 持久化的优缺点

+ 优点
  + **Redis 加载 RDB 文件恢复数据速度远快于 AOF 方式**；
  + RDB 文件是一个紧凑压缩的二进制文件，非常适合备份、全量复制等场景；
+ 缺点
  + 没办法做到实时持久化/秒级持久化。因为 **bgsave 每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高；**



## 2. AOF 持久化

以日志的方式记录每次写命令，重启时通过重新执行 AOF 文件中的命令达到恢复数据的目的；

AOF 持久化的主要作用是**解决了数据持久化的实时性**，目前 Redis 持久化的主流方式；

```
开启 AOF 持久化：修改配置值：appendonly yes
```

AOF 持久化过程可以分为命令追加、文件同步、文件重写三个步骤：

+ Redis 每执行一条写命令，就将该写命令追加到 aof_buf 缓冲区的末尾；

+ AOF 缓冲区根据配置的策略将数据同步到磁盘的 AOF 文件中；

  ```
  文件同步策略通过配置 appendfsync 选项控制：
  always:命令写入aof_buf后将调用系统fsync操作同步到 AOF文件中
  everysec（redis 默认配置值）:命令写入aof_buf后将调用系统write操作，fsync同步文件操作每秒调用一次
  no：命令写入aof_buf后将调用系统write操作，不对AOF文件进行同步操作，同步操作由操作系统控制
  
  注：write:将文件写入写缓冲区；fsync：将文件同步到磁盘
  ```

+ 随着 AOF 文件越来越大，需要定期对 AOF 进行重写，达到压缩文件的目的；

### AOF 重写

用于解决 AOF 文件体积膨胀的问题；

原理：**AOF 重写并不对现有的AOF 文件进行操作，而是通过读取服务器当前的数据库状态实现；**

使用子进程进行AOF重写，子进程进行AOF重写期间，服务器进程可以继续处理命令请求，新的命令还会对现有的数据库状态进行修改，Redis 服务器通过维护一个 **AOF重写缓冲区** ，记录子进程AOF重写期间服务器执行的所有写命令；当子进程创建AOF文件结束，服务器会将缓冲区中的所有内容追加到新AOF文件的末尾；



## 3. 重启加载

AOF 和 RDB 文件都可以用于服务器重启时的数据恢复；

+ 优先加载 AOF 文件恢复数据库（AOF持久化开启且存在AOF文件）
+ AOF 关闭或者 AOF 文件不存在时，加载 RDB 文件；

> AOF/RDB文件存在错误时，Redis启动失败并打印错误信息。